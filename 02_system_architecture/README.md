# 🏗️ 시스템 아키텍처

> **⚡ 쇼특허 (Short-Cut) v3.0 - AI 특허 선행 기술 조사 시스템**  
> Team: 뀨💕 | 작성일: 2026-01-28

---

## 1. 시스템 개요

### 1.1 목적
사용자가 특허 출원을 고려하는 아이디어를 입력하면, AI가 기존 특허 데이터베이스를 검색하여 **유사 특허**, **침해 리스크**, **회피 전략**을 제공하는 시스템

### 1.2 핵심 기술 (v3.0)

| 기술 | 설명 |
|------|------|
| **Self-RAG** | 검색 결과를 비판적으로 평가하고 재검색하는 지능형 RAG |
| **HyDE** | 가상 문서 생성으로 검색 품질 향상 |
| **Hybrid Search** | Pinecone (Dense) + BM25 (Sparse) + RRF 융합 검색 |
| **LLM Streaming** | 실시간 분석 결과 출력 (체감 대기시간 0초) |
| **4-Level Parser** | 다국어 청구항 파싱 (US/EP/KR 지원) |
| **QA Automation** | DeepEval 기반 RAG 품질 자동 검증 (Faithfulness/Relevancy) |

---

## 2. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ⚡ 쇼특허 (Short-Cut) v3.0                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌──────────────────────┐    ┌─────────────────────────┐ │
│  │   사용자    │───▶│   Streamlit App      │───▶│     OpenAI API          │ │
│  │   입력      │    │   (app.py)           │    │  ┌─────────────────────┐│ │
│  │             │    │                      │    │  │ text-embedding-3    ││ │
│  │ "아이디어"  │    │  ┌────────────────┐  │    │  │ gpt-4o-mini         ││ │
│  │  └─────────────┘    │  │  PatentAgent   │  │    │  │ gpt-4o              ││ │
│                     │  │  ┌──────────┐  │  │    │  └─────────────────────┘│ │
│                     │  │  │  HyDE    │  │  │    └─────────────────────────┘ │
│                     │  │  └──────────┘  │  │                                │
│                     │  │  ┌──────────┐  │  │    ┌─────────────────────────┐ │
│                     │  │  │ Hybrid   │  │  │    │    Vector DB (Serverless)│ │
│                     │  │  │ Search   │──┼──┼───▶│  ┌─────────────────────┐│ │
│                     │  │  └──────────┘  │  │    │  │ Pinecone (Dense)    ││ │
│                     │  │  ┌──────────┐  │  │    │  │ BM25 (Sparse)        ││ │
│                     │  │  │ Grading  │  │  │    │  │ RRF Fusion           ││ │
│                     │  │  └──────────┘  │  │    │  └─────────────────────┘│ │
│                     │  │  ┌──────────┐  │  │    │  20,664 chunks          │ │
│                     │  │  │Streaming │  │  │    └─────────────────────────┘ │
│                     │  │  │ Analysis │  │  │                                │
│                     │  │  └──────────┘  │  │                                │
│                     │  └────────────────┘  │                                │
│                     └──────────────────────┘                                │
│                            │                                                │
│                            ▼                                                │
│                     ┌─────────────────────────┐                             │
│                     │  분석 결과 (Streaming)   │                             │
│                     │ ┌─────────────────────┐ │                             │
│                     │ │ 유사도 평가         │ │                             │
│                     │ │ 침해 리스크         │ │                             │
│                     │ │ 구성요소 대비표     │ │                             │
│                     │ │ 회피 전략           │ │                             │
│                     │ └─────────────────────┘ │                             │
│                     └─────────────────────────┘                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 핵심 컴포넌트

### 3.1 Patent Agent (`patent_agent.py`)

Self-RAG 파이프라인 + Streaming 분석 엔진 + **DeepEval QA**

```
┌──────────────────────────────────────────────────────────────────────┐
│                        PatentAgent v3.0                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  [Stage 1] HyDE (Hypothetical Document Embedding)                    │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 사용자 아이디어 → GPT-4o-mini → 가상 특허 청구항               │  │
│  │ → text-embedding-3-small → 1536차원 벡터                       │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                           ↓                                          │
│  [Stage 2] Hybrid Search (Pinecone + BM25 + RRF)                     │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ Dense: Pinecone (Cosine) → Top-K vectors                          │  │
│  │ Sparse: BM25 keyword matching → Top-K docs                     │  │
│  │ RRF Fusion: k=60, weight=0.5:0.5                               │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                           ↓                                          │
│  [Stage 3] Grading & Rewrite Loop                                    │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 검색 결과 5개 → GPT-4o-mini → 관련성 점수 (0~1)                │  │
│  │ 평균 < 0.6 → 쿼리 재작성 → 재검색 (최대 1회)                   │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                           ↓                                          │
│  [Stage 4] Streaming Critical Analysis                               │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 최종 선정 특허 → GPT-4o (Streaming) → 실시간 분석              │  │
│  │ [유사도] + [침해 리스크] + [구성요소 대비표] + [회피 전략]     │  │
│  │ 각 분석마다 근거 특허 번호 명시                                │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 3.2 Vector Database (`vector_db.py`)

하이브리드 검색 엔진 (Pinecone Dense + Local BM25 Sparse + RRF)

```
┌──────────────────────────────────────────────────────────────────────┐
│                        PineconeClient v3.0                            │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐   │
│  │     Pinecone (Dense)        │  │       BM25 (Sparse)         │   │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │   │
│  │  │ Serverless Index      │  │  │  │ Local Index (pkl)     │  │   │
│  │  │ Integrated Metadata   │  │  │  │ Keyword Matching      │  │   │
│  │  │ Cosine Similarity     │  │  │  │ TF-IDF based          │  │   │
│  │  │ 20,664 vectors        │  │  │  │ 20,664 documents      │  │   │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │   │
│  │            ↓                │  │            ↓                │   │
│  │      Top-K (by score)       │  │      Top-K (by BM25)        │   │
│  └─────────────────────────────┘  └─────────────────────────────┘   │
│                    ↘                    ↙                            │
│                 ┌───────────────────────────┐                        │
│                 │    RRF Fusion (k=60)      │                        │
│                 │ ────────────────────────  │                        │
│                 │ score = Σ 1/(k + rank)    │                        │
│                 │ dense_weight: 0.5         │                        │
│                 │ sparse_weight: 0.5        │                        │
│                 └───────────────────────────┘                        │
│                             ↓                                        │
│                      Final Top-K Results                             │
│                                                                      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 4. 기술 스택

### 4.1 Backend

| 구분 | 기술 |
|------|------|
| **언어** | Python 3.11+ |
| **Web UI** | Streamlit |
| **비동기** | asyncio, nest-asyncio |
| **데이터 검증** | Pydantic v2 |
| **QA/Test** | **DeepEval** (RAG Metric), pytest |

### 4.2 AI/ML

| 구분 | 기술 |
|------|------|
| **LLM** | OpenAI GPT-4o, GPT-4o-mini |
| **Embedding** | OpenAI text-embedding-3-small (1536차원) |
| **Dense Search** | Pinecone Serverless (Cosine) |
| **Sparse Search** | rank-bm25 (Okapi BM25) |
| **Fusion** | RRF (Reciprocal Rank Fusion) |
| **NLP** | Spacy en_core_web_sm (선택) |

---

## 5. API 설계

### 5.1 OpenAI API 사용

| 모델 | 용도 | 비용 |
|------|------|------|
| `text-embedding-3-small` | 텍스트 임베딩 | $0.02/1M tokens |
| `gpt-4o-mini` | HyDE, Grading, Query Rewrite, **DeepEval Metric** | $0.15/1M input |
| `gpt-4o` | Critical Analysis (Streaming) | $5.00/1M input |

---

## 6. 품질 검증 (DeepEval)

RAG 파이프라인의 신뢰성을 보장하기 위해 DeepEval 프레임워크를 도입하였습니다 (`tests/test_evaluation.py`).

| 메트릭 (Metric) | 설명 | Threshold | 달성 현황 |
|-----------------|------|-----------|-----------|
| **Faithfulness** | 답변이 검색된 컨텍스트(특허)에 충실한지 검증 (Hallucination 방지) | 0.7 | ✅ PASS (100%) |
| **Answer Relevancy** | 답변이 사용자 질문과 관련 있는지 검증 | 0.7 | ✅ PASS (100%) |

---

## 7. 성능 지표

| 항목 | v2.0 | v3.0 |
|------|------|------|
| 검색 품질 | 70-75% (BM25) | **92-95%** (Hybrid RRF) |
| 파싱 성공률 | ~90% | **~95%** (4-Level) |
| 응답 체감 시간 | 10-15초 | **0초** (Streaming) |
| 테스트 커버리지 | 0% | **100%** (31 tests) |

> 📋 상세 테스트 결과는 [03_test_report/](../03_test_report/)를 참고하세요.

---

*작성: ⚡ 쇼특허 (Short-Cut) Team - 뀨💕*
